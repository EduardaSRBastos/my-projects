name: Update Projects List

on:
  schedule:
    - cron: "0 0 */3 * *"  # Every 3 days at midnight UTC
  workflow_dispatch:

jobs:
  update-projects:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout develop branch
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: develop
          fetch-depth: 0
          persist-credentials: false

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv requests

      # 4a. Generate README
      - name: Generate README
        env:
          GITHUB_USERNAME: ${{ secrets.GIT_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: python generate_README_projects_list.py

      # 4b. Commit README changes
      - name: Commit README
        id: commit_readme
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "no_readme_changes=true" >> $GITHUB_OUTPUT
            echo "No README changes"
          else
            git commit -m "Update README projects list [ci skip]"
            git push https://x-access-token:${{ secrets.GIT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:develop
            echo "no_readme_changes=false" >> $GITHUB_OUTPUT
          fi

      # 4c. Generate WEBSITE_PROJECTS_LIST.json
      - name: Generate WEBSITE_PROJECTS_LIST
        env:
          GITHUB_USERNAME: ${{ secrets.GIT_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: python generate_WEBSITE_projects_list.py

      # 4d. Commit WEBSITE_PROJECTS_LIST.json changes
      - name: Commit WEBSITE_PROJECTS_LIST
        id: commit_website
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add WEBSITE_PROJECTS_LIST.json
          if git diff --cached --quiet; then
            echo "no_website_changes=true" >> $GITHUB_OUTPUT
            echo "No WEBSITE_PROJECTS_LIST.json changes"
          else
            git commit -m "Update WEBSITE_PROJECTS_LIST.json [ci skip]"
            git push https://x-access-token:${{ secrets.GIT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:develop
            echo "no_website_changes=false" >> $GITHUB_OUTPUT
          fi 

      # 5. Notify new projects via GitHub issue
      - name: Notify new projects added
        if: steps.commit_website.outputs.no_website_changes == 'false'
        env:
          GITHUB_USERNAME: ${{ secrets.GIT_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/issues \
            -d "{\"title\":\"Projects List Updated\", \
                \"body\":\"New projects have been added to the projects list. Check the latest commit on the develop branch.\", \
                \"labels\":[\"automation\"], \
                \"assignees\":[\"${GITHUB_USERNAME}\"]}"